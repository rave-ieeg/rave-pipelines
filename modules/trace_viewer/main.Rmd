---
title: "RAVE Pipeline Markdown Template"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE}
# This code block sets up the engine environment
# Please do not remove me
ravepipeline::pipeline_setup_rmd("trace_viewer")
```


```{rave load_subject, language = "R", export = "subject"}
subject <- ravecore::RAVESubject$new(
  project_name = project_name, 
  subject_code = subject_code
)
```

With `export="subject"`, the subject variable will be registered for the following chunks to use. Be aware that all other variables created in this block will not be exposed.

#### Step 2: Load epoch and reference information

```{rave load_repository, language = "R", export = "repository"}
repository <- switch (
  repository_datatype,
  "voltage" = {
    ravecore::prepare_subject_voltage_with_blocks(
      subject = subject,
      electrodes = loaded_electrodes,
      blocks = subject$blocks,
      reference_name = reference_name,
      strict = TRUE, 
      downsample = pre_downsample,
      # Load data and generate cache
      lazy_load = FALSE
    )
  },
  {
    ravecore::prepare_subject_raw_voltage_with_blocks(
      subject = subject,
      electrodes = loaded_electrodes,
      blocks = subject$blocks,
      strict = TRUE, 
      downsample = pre_downsample,
      # Load data and generate cache
      lazy_load = FALSE
    )
  }
)
```

```{rave generate_annotation_table, language = "R", export = "annotation_table"}
if(is.null(epoch_name) || is.na(epoch_name)) {
  annotation_table <- NULL
} else {
  epoch <- ravecore::RAVEEpoch$new(subject = subject, name = epoch_name)
  epoch_events <- unique(c("", epoch_events))
  epoch_events <- epoch_events[epoch_events %in% epoch$available_events]
  annotation_table <- data.table::rbindlist(lapply(seq_along(epoch_events), function(ii) {
    event_name <- epoch_events[[ii]]
    event_cname <- epoch$get_event_colname(event = event_name, missing = "warning")
    if(event_name == "") { event_name <- "Onset" }
    annotation_table <- data.frame(
      block = epoch$table$Block,
      time = epoch$table[[event_cname]], 
      label = sprintf(
        "%s[%s,t=%.1f]<br>%s",
        event_name,
        epoch$table$Trial,
        epoch$table[[event_cname]],
        epoch$table$Condition
      ), 
      group = event_name,
      color = ii + 1
    )
  }))
}
```


## Build, Visualize, & Run

Please make sure the following code block is at the end of your pipeline file. This block will build the pipeline and generate a `make-trace_viewer.R` script with your pipeline markdown file. `RAVE` will use the generated pipeline script to execute the pipeline in the dashboard application, or in massive production mode.

```{r build, echo=FALSE, results='hide'}
build_pipeline(make_file = "make-trace_viewer.R")
```


Once the pipeline script `make-trace_viewer.R` is built, you can visualize and execute the pipeline without the need of re-knit this document. Notice we use `r` block instead of `rave`. (This is because the code blocks are not part of pipeline targets.)

```{r visualize, echo=FALSE}
# Fixed usage, show pipeline graph
try({
  asNamespace("ravepipeline")$pipeline_dependency_graph(
    pipeline_path = ".", glimpse = TRUE)
}, silent = TRUE)
```



