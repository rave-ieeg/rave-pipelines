---
date: "`r Sys.Date()`"
description: | 
  <small><i>
    An automated report generated by 
    <a target="_blank" href="https://rave.wiki">
      RAVE
    </a>
    on `r strftime(Sys.Date(), '%b %d, %Y')`
  </i></small>
output: 
  html_document:
    theme: flatly
    code_folding: hide
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float: true
  distill::distill_article:
    theme: flatly
    code_folding: true
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float: true
    css: "report_styles.css"
params:
  project_name: demo
  template_subject: ~
  use_cache: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE
)

# This document must be built under pipeline directory
```

*Click on the `Show` button to reveal preparation scripts.*

```{r initial_setup}
# Print out the building parameters of this report:
ieegio::io_write_yaml(params, stdout())

# Load project
project <- ravecore::as_rave_project(params$project_name)

# find all subjects
subject_codes <- project$subjects()

# Prepare for the template subject
template_subject <- params$template_subject
if(length(template_subject) != 1) {
  template_subject <- ravepipeline::raveio_getopt("threeBrain_template_subject",
                                                  default = "N27")
}

# Cached data will be stored at this directory, relative to the pipeline
cache_path <- file.path("build", "cache", project$name)
cache_path <- ravepipeline::dir_create2(cache_path)
```

---
title: "`r sprintf('%s (%d subjects)', project$name, length(subject_codes))`"
---

<div id="href_prefix" class="hidden" style="display:none !important;">
`r sprintf('build/cache/%s', project$name)`
</div>

## Group viewers

```{r build_group_viewer, results='hidden'}
# For each subject code, create brain object
subject_brain_models <- lapply(subject_codes, function(subject_code) {
  subject <- ravecore::new_rave_subject(project_name = project,
                                        subject_code = subject_code,
                                        strict = FALSE)
  brain <- ravecore::rave_brain(subject)
  brain$set_electrode_values()
  brain
})
template_brain <- threeBrain::merge_brain(
  subject_brain_models,
  template_subject = template_subject,
  template_surface_types = c("pial", "smoothwm", "inflated", "sphere", "sphere.reg")
)
# save cache
viewer <- template_brain$plot(controllers = list("Display Data" = "[Subject]"))
```

```{r, show_viewer, echo=FALSE, results='asis'}
viewer_path <- threeBrain::save_brain(
  widget = viewer,
  path = file.path(
    cache_path,
    sprintf("group_viewer-%s.html", template_subject)
  ),
  title = project$name
)
viewer_names <- list.files(
  cache_path,
  pattern = "^group_viewer.*\\.html",
  include.dirs = FALSE,
  recursive = FALSE,
  full.names = FALSE,
  all.files = FALSE,
  ignore.case = TRUE
)
rel_paths <- ravecore:::path_rel(viewer_names, start = ".")
htmltools::tags$ul(
  lapply(viewer_names, function(viewer_name) {
    htmltools::tags$li(htmltools::tags$a(
      viewer_name, `data-href` = viewer_name, target = "_blank"))
  })
)
```

## Electrode Summary

```{r electrode_summary_table}
#| layout: 'l-screen-insert-right'
electrode_tables <- lapply(subject_codes, function(subject_code) {
  subject <- ravecore::new_rave_subject(project_name = project,
                                        subject_code = subject_code,
                                        strict = FALSE)
  tbl <- tryCatch({subject$get_electrode_table()}, error = function(e) { NULL })
  if(!is.data.frame(tbl) || !nrow(tbl)) { return(NULL) }
  if(!length(tbl$FSLabel)) {
    tbl$FSLabel <- "Unknown"
  }
  data.frame(
    Subject = subject$subject_code,
    FSLabel = tbl$FSLabel
  )
})
electrode_tables <- data.table::rbindlist(electrode_tables)
summary_table <- reshape2::dcast(electrode_tables,
                                 FSLabel ~ Subject,
                                 fun.aggregate = length,
                                 fill = 0, value.var = "FSLabel")
DT::datatable(
  summary_table,
  class = "compact stripe nowrap",
  rownames = FALSE,
  fillContainer = FALSE,
  options = list(
    scrollX = TRUE,        # allow horizontal scrolling
    scrollY = FALSE,
    lengthMenu = list(c(10, 25, 50, 100, -1), c("10", "25", "50", "100", "All")), 
    paging = TRUE
  )
)
```

## Subject Summary

```{r subject_summary, results='hide'}
cache_table <- function(table, subject, name, digit_cnames = NULL, digits = 2) {
  cache_path <- ravecore:::file_path("build", "cache", subject$project_name, subject$subject_code, name, ext = "html")
  if(!is.data.frame(table) || !nrow(table)) {
    if(file.exists(cache_path)) {
      unlink(cache_path)
    }
    return(NULL)
  }
  table <- as.data.frame(table)
  table_names <- names(table)
  table <- table[, !grepl("^X(\\.[0-9]+|)$", table_names)]
  widget <- DT::datatable(
    table,
    class = "compact stripe nowrap",
    rownames = FALSE,
    fillContainer = FALSE,
    options = list(
      scrollX = TRUE,        # allow horizontal scrolling
      scrollY = FALSE,
      pageLength = -1,                     # show all rows by default
      lengthMenu = list(c(20, 50, 100, -1), c("20", "50", "100", "All")), 
      paging = TRUE
    )
  )
  if(length(digit_cnames)) {
    widget <- DT::formatRound(widget, digits = digits, columns = digit_cnames)
  }
  css <- "
  html, body { height:100%; width:100%; margin:0 !important; padding:0 !important; }
  .dataTables_wrapper { height:100% !important; width:100% !important; box-sizing:border-box; }
  "
  styled_tbl <- htmlwidgets::prependContent(widget, htmltools::tags$style(htmltools::HTML(css)))
  DT::saveWidget(
    widget = styled_tbl,
    file = cache_path,
    selfcontained = TRUE,
    title = subject$subject_id
  )
  list(
    nrows = nrow(table),
    path = sprintf("%s/%s.html", subject$subject_code, name)
  )
}

subject_summary <- lapply(subject_codes, function(subject_code) {
  subject <- ravecore::new_rave_subject(project_name = project,
                                        subject_code = subject_code,
                                        strict = FALSE)
  subject_cache_path <- ravepipeline::dir_create2(file.path(cache_path, subject$subject_code))
  
  # viewer
  brain <- ravecore::rave_brain(subject)
  if(!is.null(brain)) {
    widget <- brain$plot()
    threeBrain::save_brain(widget, file.path(subject_cache_path, "viewer.html"))
    brain_viewer <- list(
      path = sprintf("%s/viewer.html", subject$subject_code)
    )
  } else {
    brain_viewer <- NULL
  }
  
  # electrode table
  electrode_table <- tryCatch({subject$get_electrode_table()}, error = function(e) { NULL })
  cnames <- names(electrode_table)
  cnames <- cnames[
    grepl("_[xyz]$", cnames) | 
      grepl("T1[RAS]", cnames) | 
      cnames %in% c("DistanceShifted", "DistanceToPial")
  ]
  electrode_table <- cache_table(electrode_table, subject = subject, name = "electrode_table", digit_cnames = cnames, digits = 1)
  
  # Epochs
  epoch_tables <- lapply(subject$epoch_names, function(epoch_name) {
    tryCatch(
      {
        epoch_table <- subject$meta_data(meta_type = "epoch", meta_name = epoch_name, strict = TRUE)
        cnames <- "Time"
        cnames <- cnames[cnames %in% names(epoch_table)]
        epoch_table <- cache_table(epoch_table, subject = subject, name = sprintf("epoch-%s", epoch_name), digit_cnames = cnames, digits = 3)
        
        htmltools::tags$li(
          htmltools::a(
            htmltools::span(
              htmltools::strong(epoch_name), sprintf(": %d", epoch_table$nrows)
            ),
            `data-href` = epoch_table$path,
            target = "_blank"
          )
        )
      },
      error = function(e) {
        NULL
      }
    )
  })
  epoch_tables <- htmltools::tags$ul(epoch_tables)
  
  # References
  reference_tables <- lapply(subject$reference_names, function(reference_name) {
    tryCatch(
      {
        reference_table <- subject$meta_data(meta_type = "references", meta_name = reference_name, strict = TRUE)
        reference_table <- cache_table(reference_table, subject = subject, name = sprintf("reference-%s", reference_name))
        
        htmltools::tags$li(
          htmltools::a(
            reference_name,
            `data-href` = reference_table$path,
            target = "_blank"
          )
        )
      },
      error = function(e) {
        NULL
      }
    )
  })
  reference_tables <- htmltools::tags$ul(reference_tables)
  
  if(length(brain_viewer)) {
    viewer_html <- htmltools::tagList("(", htmltools::a(
      "viewer", `data-href` = brain_viewer$path, target = "_blank"), ")")
  } else {
    viewer_html <- ""
  }
  
  if(length(electrode_table)) {
    electrode_info <- htmltools::span(
      htmltools::a(
        sprintf("n=%d", electrode_table$nrows),
        `data-href` = electrode_table$path,
        target = "_blank"
      ),
      " ",
      viewer_html
    )
  } else {
    electrode_info <- htmltools::span(
      "[missing table]",
      " ",
      viewer_html
    )
  }
  
  data.frame(
    Subject = subject$subject_code,
    Electrodes = paste(format(electrode_info), collapse = "\n"),
    ImportedBlocks = paste(subject$blocks, collapse = ", "),
    Epochs = paste(format(epoch_tables), collapse = "\n"),
    References = paste(format(reference_tables), collapse = "\n")
  )
  # list(
  #   brain_viewer = brain_viewer,
  #   electrode_table = electrode_table,
  #   epoch_tables = epoch_tables,
  #   reference_tables = reference_tables
  # )
})

subject_summary <- do.call("rbind", subject_summary)
```

```{r subject_summary_table, echo = FALSE}
#| layout: 'l-screen-insert-right'
DT::datatable(
  subject_summary,
  class = "compact stripe nowrap",
  rownames = FALSE,
  escape = FALSE,
  fillContainer = FALSE,
  options = list(
    dom = 't',
    scrollX = TRUE,        # allow horizontal scrolling
    scrollY = FALSE,
    pageLength = -1,                     # show all rows by default
    lengthMenu = list(c(20, 50, 100, -1), c("20", "50", "100", "All")), 
    paging = TRUE
  )
)
```

## Validation Summary


```{r generate_validation_reports, results='hide'}
# validator_summary <- lapply(subject_codes, function(subject_code) {
#   subject <- ravecore::new_rave_subject(project_name = project,
#                                         subject_code = subject_code,
#                                         strict = FALSE)
#   res <- ravecore::validate_subject(subject)
#   # save the validation results 
#   cache_path <- ravecore:::file_path("build", "cache", subject$project_name, subject$subject_code, "validation.rds")
#   saveRDS(res, file = cache_path)
#   res <- as.list(res, recursive = TRUE)
#   res <- unlist(res, use.names = TRUE, recursive = FALSE)
#   
#   valids <- lapply(names(res), function(nm) {
#     v <- res[[nm]]
#     if(isFALSE(v$valid)) {
#       return(list(
#         Key = nm,
#         Description = v$description,
#         Validation = sprintf("[%s] %s", v$severity, 
#                          paste(v$message, collapse = ""))
#       ))
#     } else {
#       return(NULL)
#     }
#   })
#   table <- data.table::rbindlist(valids)
#   if(nrow(table) == 0) {
#     table <- NULL
#   }
# })
# validator_summary <- data.table::rbindlist(validator_summary)
```

```{r display_validator_summary}
#| layout: 'l-screen-insert-right'
# DT::datatable(
#   validator_summary,
#   class = "compact stripe",
#   rownames = FALSE,
#   escape = FALSE,
#   fillContainer = FALSE,
#   options = list(
#     dom = 't',
#     scrollX = TRUE,        # allow horizontal scrolling
#     scrollY = FALSE,
#     paging = TRUE
#   )
# )
```

<script>
document.addEventListener("DOMContentLoaded", function() {
  const el = document.getElementById('href_prefix');
  if(el) {
    const prefix = el.textContent.trim();
    const hrefs = document.querySelectorAll("a[data-href]");
    hrefs.forEach(href => {
      const link = href.getAttribute("data-href");
      href.href = `${prefix}/${link}`;
      href.target = "_blank";
    });
  }
});
</script>
